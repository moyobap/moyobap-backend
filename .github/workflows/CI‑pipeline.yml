name: CI Pipeline

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    env:
      SPRING_DATA_REDIS_HOST: 127.0.0.1
      SPRING_DATA_REDIS_PORT: 6379
      MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
      MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Start MySQL
        run: |
          docker run -d \
            -e MYSQL_ROOT_PASSWORD=${MYSQL_PASSWORD} \
            -e MYSQL_DATABASE=${MYSQL_DATABASE} \
            -p 3306:3306 \
            --name mysql-for-ci \
            mysql:8.0

      - name: Start Redis
        run: |
          docker run -d \
            -p 6379:6379 \
            --name redis-for-ci \
            redis:7.2

      - name: Wait for MySQL to be ready
        run: |
          echo "Waiting for MySQL..."
          for i in {1..30}; do
            if docker exec mysql-for-ci mysqladmin ping -uroot -p"${MYSQL_PASSWORD}" --silent; then
              echo "MySQL is ready"
              break
            fi
            echo "Waiting..."
            sleep 3
          done

      - name: Grant Gradle permission
        run: chmod +x ./gradlew

      - name: Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: gradle-${{ runner.os }}-

      - name: Run Tests (test profile)
        run: ./gradlew clean test --stacktrace -Dspring.profiles.active=test

      - name: Build jar (without re-running tests)
        run: ./gradlew build -x test --stacktrace